import { TreeDiagramNode } from './node.class';
import { TreeDiagramNodeMaker } from './node-maker.class';
export class TreeDiagramNodesList {
    constructor(nodes, config) {
        this.config = config;
        this.nodeTemplate = {
            displayName: 'New node',
            children: [],
            guid: '',
            parentId: null
        };
        this.nodesList = new Map();
        nodes.forEach(treeNode => {
            this.nodesList.set(treeNode.guid, new TreeDiagramNode(treeNode, config, this.getThisNodeList.bind(this)));
        });
        this.makeRoots();
        this.makerGuid = this.uuidv4();
        const node = {
            guid: this.makerGuid,
            parentId: 'root',
            children: [],
            displayName: 'New node'
        };
        const maker = new TreeDiagramNodeMaker(node, this.config, this.getThisNodeList.bind(this));
        this.nodesList.set(this.makerGuid, maker);
    }
    values() {
        return this.nodesList.values();
    }
    getNode(guid) {
        return this.nodesList.get(guid);
    }
    rootNode(guid) {
        const node = this.getNode(guid);
        const maker = this.getNode(this.makerGuid);
        node.isDragging = false;
        node.isDragover = false;
        if (node.parentId) {
            const parent = this.getNode(node.parentId);
            parent.children.delete(guid);
        }
        node.parentId = null;
        this.makeRoots();
        maker.isDragging = false;
        maker.isDragover = false;
    }
    transfer(originId, targetId) {
        const origin = this.getNode(originId);
        const target = this.getNode(targetId);
        origin.isDragover = false;
        origin.isDragging = false;
        target.isDragover = false;
        if (origin.parentId === targetId || originId === targetId) {
            return;
        }
        const remakeRoots = origin.isRoot();
        if (origin.parentId) {
            const parent = this.getNode(origin.parentId);
            parent.children.delete(originId);
            if (!parent.hasChildren()) {
                parent.toggle(false);
            }
        }
        target.children.add(originId);
        origin.parentId = targetId;
        if (remakeRoots) {
            this.makeRoots();
        }
        this.serialize();
    }
    getThisNodeList() {
        return this;
    }
    toggleSiblings(guid) {
        const target = this.getNode(guid);
        if (target.parentId) {
            const parent = this.getNode(target.parentId);
            parent.children.forEach(nodeGuid => {
                if (nodeGuid === guid) {
                    return;
                }
                this.getNode(nodeGuid).toggle(false);
            });
        }
        else {
            for (const root of this.roots) {
                if (root.guid === guid) {
                    continue;
                }
                root.toggle(false);
            }
        }
    }
    serialize() {
        const out = [];
        this.nodesList.forEach((node) => {
            const json = {
                guid: node.guid,
                displayName: node.displayName,
                parentId: node.parentId,
                children: Array.from(node.children),
            };
            out.push(json);
        });
        return out;
    }
    destroy(guid) {
        const target = this.getNode(guid);
        if (target.parentId) {
            const parent = this.getNode(target.parentId);
            parent.children.delete(guid);
        }
        if (target.hasChildren()) {
            target.children.forEach((child) => {
                this.nodesList.delete(child);
            });
        }
        this.nodesList.delete(guid);
    }
    newNode(parentId = null) {
        const nodeTemplate = Object.assign({}, this.nodeTemplate);
        nodeTemplate.guid = this.uuidv4();
        nodeTemplate.parentId = parentId;
        this.nodesList.set(nodeTemplate.guid, new TreeDiagramNode(nodeTemplate, this.config, this.getThisNodeList.bind(this)));
        this.makeRoots();
        return nodeTemplate.guid;
    }
    uuidv4() {
        // tslint:disable-next-line:only-arrow-functions
        return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
            // tslint:disable-next-line:one-variable-per-declaration no-bitwise
            const r = (Math.random() * 16) | 0, 
            // tslint:disable-next-line:triple-equals no-bitwise
            v = c == 'x' ? r : (r & 0x3) | 0x8;
            return v.toString(16);
        });
    }
    makeRoots() {
        this.roots = Array.from(this.values()).filter((node) => node.isRoot());
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibm9kZXMtbGlzdC5jbGFzcy5qcyIsInNvdXJjZVJvb3QiOiJuZzovL2FuZ3VsYXIyLXRyZWUtZGlhZ3JhbS8iLCJzb3VyY2VzIjpbImxpYi9jbGFzc2VzL25vZGVzLWxpc3QuY2xhc3MudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLGNBQWMsQ0FBQztBQUMvQyxPQUFPLEVBQUUsb0JBQW9CLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQztBQUUxRCxNQUFNLE9BQU8sb0JBQW9CO0lBWS9CLFlBQVksS0FBWSxFQUFVLE1BQU07UUFBTixXQUFNLEdBQU4sTUFBTSxDQUFBO1FBUGhDLGlCQUFZLEdBQUc7WUFDckIsV0FBVyxFQUFFLFVBQVU7WUFDdkIsUUFBUSxFQUFFLEVBQUU7WUFDWixJQUFJLEVBQUUsRUFBRTtZQUNSLFFBQVEsRUFBRSxJQUFJO1NBQ2YsQ0FBQztRQUdBLElBQUksQ0FBQyxTQUFTLEdBQUcsSUFBSSxHQUFHLEVBQUUsQ0FBQztRQUMzQixLQUFLLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxFQUFFO1lBQ3ZCLElBQUksQ0FBQyxTQUFTLENBQUMsR0FBRyxDQUNoQixRQUFRLENBQUMsSUFBSSxFQUNiLElBQUksZUFBZSxDQUFDLFFBQVEsRUFBRSxNQUFNLEVBQUUsSUFBSSxDQUFDLGVBQWUsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FDdkUsQ0FBQztRQUNKLENBQUMsQ0FBQyxDQUFDO1FBQ0gsSUFBSSxDQUFDLFNBQVMsRUFBRSxDQUFDO1FBQ2pCLElBQUksQ0FBQyxTQUFTLEdBQUcsSUFBSSxDQUFDLE1BQU0sRUFBRSxDQUFDO1FBRS9CLE1BQU0sSUFBSSxHQUFHO1lBQ1gsSUFBSSxFQUFFLElBQUksQ0FBQyxTQUFTO1lBQ3BCLFFBQVEsRUFBRSxNQUFNO1lBQ2hCLFFBQVEsRUFBRSxFQUFFO1lBQ1osV0FBVyxFQUFFLFVBQVU7U0FDeEIsQ0FBQztRQUNGLE1BQU0sS0FBSyxHQUFH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SUFBSSxDQUFDLE1BQU0sRUFBRSxHQUFHLEVBQUUsQ0FBQyxHQUFHLENBQUM7WUFDaEMsb0RBQW9EO1lBQ3BELENBQUMsR0FBRyxDQUFDLElBQUksR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxHQUFHLEdBQUcsQ0FBQyxHQUFHLEdBQUcsQ0FBQztZQUVyQyxPQUFPLENBQUMsQ0FBQyxRQUFRLENBQUMsRUFBRSxDQUFDLENBQUM7UUFDeEIsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDO0lBRU8sU0FBUztRQUNmLElBQUksQ0FBQyxLQUFLLEdBQUcsS0FBSyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsTUFBTSxFQUFFLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxJQUFxQixFQUFFLEVBQUUsQ0FDdEUsSUFBSSxDQUFDLE1BQU0sRUFBRSxDQUNkLENBQUM7SUFDSixDQUFDO0NBQ0YiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBUcmVlRGlhZ3JhbU5vZGUgfSBmcm9tICcuL25vZGUuY2xhc3MnO1xuaW1wb3J0IHsgVHJlZURpYWdyYW1Ob2RlTWFrZXIgfSBmcm9tICcuL25vZGUtbWFrZXIuY2xhc3MnO1xuXG5leHBvcnQgY2xhc3MgVHJlZURpYWdyYW1Ob2Rlc0xpc3Qge1xuICBwdWJsaWMgcm9vdHM6IFRyZWVEaWFncmFtTm9kZVtdO1xuICBwdWJsaWMgbWFrZXJHdWlkOiBzdHJpbmc7XG4gIHB1YmxpYyBkcmFnZ2luZ05vZGVHdWlkO1xuICBwcml2YXRlIG5vZGVzTGlzdDogTWFwPHN0cmluZywgVHJlZURpYWdyYW1Ob2RlPjtcbiAgcHJpdmF0ZSBub2RlVGVtcGxhdGUgPSB7XG4gICAgZGlzcGxheU5hbWU6ICdOZXcgbm9kZScsXG4gICAgY2hpbGRyZW46IFtdLFxuICAgIGd1aWQ6ICcnLFxuICAgIHBhcmVudElkOiBudWxsXG4gIH07XG5cbiAgY29uc3RydWN0b3Iobm9kZXM6IGFueVtdLCBwcml2YXRlIGNvbmZpZykge1xuICAgIHRoaXMubm9kZXNMaXN0ID0gbmV3IE1hcCgpO1xuICAgIG5vZGVzLmZvckVhY2godHJlZU5vZGUgPT4ge1xuICAgICAgdGhpcy5ub2Rlc0xpc3Quc2V0KFxuICAgICAgICB0cmVlTm9kZS5ndWlkLFxuICAgICAgICBuZXcgVHJlZURpYWdyYW1Ob2RlKHRyZWVOb2RlLCBjb25maWcsIHRoaXMuZ2V0VGhpc05vZGVMaXN0LmJpbmQodGhpcykpXG4gICAgICApO1xuICAgIH0pO1xuICAgIHRoaXMubWFrZVJvb3RzKCk7XG4gICAgdGhpcy5tYWtlckd1aWQgPSB0aGlzLnV1aWR2NCgpO1xuXG4gICAgY29uc3Qgbm9kZSA9IHtcbiAgICAgIGd1aWQ6IHRoaXMubWFrZXJHdWlkLFxuICAgICAgcGFyZW50SWQ6ICdyb290JyxcbiAgICAgIGNoaWxkcmVuOiBbXSxcbiAgICAgIGRpc3BsYXlOYW1lOiAnTmV3IG5vZGUnXG4gICAgfTtcbiAgICBjb25zdCBtYWtlciA9IG5ldyBUcmVlRGlhZ3JhbU5vZGVNYWtlcihcbiAgICAgIG5vZGUsXG4gICAgICB0aGlzLmNvbmZpZyxcbiAgICAgIHRoaXMuZ2V0VGhpc05vZGVMaXN0LmJpbmQodGhpcylcbiAgICApO1xuXG4gICAgdGhpcy5ub2Rlc0xpc3Quc2V0KHRoaXMubWFrZXJHdWlkLCBtYWtlcik7XG4gIH1cblxuICBwdWJsaWMgdmFsdWVzKCkge1xuICAgIHJldHVybiB0aGlzLm5vZGVzTGlzdC52YWx1ZXMoKTtcbiAgfVxuXG4gIHB1YmxpYyBnZXROb2RlKGd1aWQ6IHN0cmluZyk6IFRyZWVEaWFncmFtTm9kZSB7XG4gICAgcmV0dXJuIHRoaXMubm9kZXNMaXN0LmdldChndWlkKTtcbiAgfVxuXG4gIHB1YmxpYyByb290Tm9kZShndWlkOiBzdHJpbmcpIHtcbiAgICBjb25zdCBub2RlID0gdGhpcy5nZXROb2RlKGd1aWQpO1xuICAgIGNvbnN0IG1ha2VyID0gdGhpcy5nZXROb2RlKHRoaXMubWFrZXJHdWlkKTtcblxuICAgIG5vZGUuaXNEcmFnZ2luZyA9IGZhbHNlO1xuICAgIG5vZGUuaXNEcmFnb3ZlciA9IGZhbHNlO1xuXG4gICAgaWYgKG5vZGUucGFyZW50SWQpIHtcbiAgICAgIGNvbnN0IHBhcmVudCA9IHRoaXMuZ2V0Tm9kZShub2RlLnBhcmVudElkKTtcbiAgICAgIHBhcmVudC5jaGlsZHJlbi5kZWxldGUoZ3VpZCk7XG4gICAgfVxuXG4gICAgbm9kZS5wYXJlbnRJZCA9IG51bGw7XG5cbiAgICB0aGlzLm1ha2VSb290cygpO1xuICAgIG1ha2VyLmlzRHJhZ2dpbmcgPSBmYWxzZTtcbiAgICBtYWtlci5pc0RyYWdvdmVyID0gZmFsc2U7XG4gIH1cblxuICBwdWJsaWMgdHJhbnNmZXIob3JpZ2luSWQ6IHN0cmluZywgdGFyZ2V0SWQ6IHN0cmluZykge1xuICAgIGNvbnN0IG9yaWdpbiA9IHRoaXMuZ2V0Tm9kZShvcmlnaW5JZCk7XG4gICAgY29uc3QgdGFyZ2V0ID0gdGhpcy5nZXROb2RlKHRhcmdldElkKTtcblxuICAgIG9yaWdpbi5pc0RyYWdvdmVyID0gZmFsc2U7XG4gICAgb3JpZ2luLmlzRHJhZ2dpbmcgPSBmYWxzZTtcbiAgICB0YXJnZXQuaXNEcmFnb3ZlciA9IGZhbHNlO1xuXG4gICAgaWYgKG9yaWdpbi5wYXJlbnRJZCA9PT0gdGFyZ2V0SWQgfHwgb3JpZ2luSWQgPT09IHRhcmdldElkKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgY29uc3QgcmVtYWtlUm9vdHMgPSBvcmlnaW4uaXNSb290KCk7XG5cbiAgICBpZiAob3JpZ2luLnBhcmVudElkKSB7XG4gICAgICBjb25zdCBwYXJlbnQgPSB0aGlzLmdldE5vZGUob3JpZ2luLnBhcmVudElkKTtcblxuICAgICAgcGFyZW50LmNoaWxkcmVuLmRlbGV0ZShvcmlnaW5JZCk7XG5cbiAgICAgIGlmICghcGFyZW50Lmhhc0NoaWxkcmVuKCkpIHtcbiAgICAgICAgcGFyZW50LnRvZ2dsZShmYWxzZSk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgdGFyZ2V0LmNoaWxkcmVuLmFkZChvcmlnaW5JZCk7XG4gICAgb3JpZ2luLnBhcmVudElkID0gdGFyZ2V0SWQ7XG5cbiAgICBpZiAocmVtYWtlUm9vdHMpIHtcbiAgICAgIHRoaXMubWFrZVJvb3RzKCk7XG4gICAgfVxuXG4gICAgdGhpcy5zZXJpYWxpemUoKTtcbiAgfVxuXG4gIHB1YmxpYyBnZXRUaGlzTm9kZUxpc3QoKSB7XG4gICAgcmV0dXJuIHRoaXM7XG4gIH1cblxuICBwdWJsaWMgdG9nZ2xlU2libGluZ3MoZ3VpZDogc3RyaW5nKSB7XG4gICAgY29uc3QgdGFyZ2V0ID0gdGhpcy5nZXROb2RlKGd1aWQpO1xuXG4gICAgaWYgKHRhcmdldC5wYXJlbnRJZCkge1xuICAgICAgY29uc3QgcGFyZW50ID0gdGhpcy5nZXROb2RlKHRhcmdldC5wYXJlbnRJZCk7XG5cbiAgICAgIHBhcmVudC5jaGlsZHJlbi5mb3JFYWNoKG5vZGVHdWlkID0+IHtcbiAgICAgICAgaWYgKG5vZGVHdWlkID09PSBndWlkKSB7XG4gICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5nZXROb2RlKG5vZGVHdWlkKS50b2dnbGUoZmFsc2UpO1xuICAgICAgfSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGZvciAoY29uc3Qgcm9vdCBvZiB0aGlzLnJvb3RzKSB7XG4gICAgICAgIGlmIChyb290Lmd1aWQgPT09IGd1aWQpIHtcbiAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJvb3QudG9nZ2xlKGZhbHNlKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBwdWJsaWMgc2VyaWFsaXplKCkge1xuICAgIGNvbnN0IG91dCA9IFtdO1xuXG4gICAgdGhpcy5ub2Rlc0xpc3QuZm9yRWFjaCgobm9kZTogVHJlZURpYWdyYW1Ob2RlKSA9PiB7XG4gICAgICBjb25zdCBqc29uOiBhbnkgPSB7XG4gICAgICAgIGd1aWQ6IG5vZGUuZ3VpZCxcbiAgICAgICAgZGlzcGxheU5hbWU6IG5vZGUuZGlzcGxheU5hbWUsXG4gICAgICAgIHBhcmVudElkOiBub2RlLnBhcmVudElkLFxuICAgICAgICBjaGlsZHJlbjogQXJyYXkuZnJvbShub2RlLmNoaWxkcmVuKSxcbiAgICAgIH07XG5cbiAgICAgIG91dC5wdXNoKGpzb24pO1xuICAgIH0pO1xuXG4gICAgcmV0dXJuIG91dDtcbiAgfVxuXG4gIHB1YmxpYyBkZXN0cm95KGd1aWQ6IHN0cmluZykge1xuICAgIGNvbnN0IHRhcmdldCA9IHRoaXMuZ2V0Tm9kZShndWlkKTtcblxuICAgIGlmICh0YXJnZXQucGFyZW50SWQpIHtcbiAgICAgIGNvbnN0IHBhcmVudCA9IHRoaXMuZ2V0Tm9kZSh0YXJnZXQucGFyZW50SWQpO1xuICAgICAgcGFyZW50LmNoaWxkcmVuLmRlbGV0ZShndWlkKTtcbiAgICB9XG5cbiAgICBpZiAodGFyZ2V0Lmhhc0NoaWxkcmVuKCkpIHtcbiAgICAgIHRhcmdldC5jaGlsZHJlbi5mb3JFYWNoKChjaGlsZDogc3RyaW5nKSA9PiB7XG4gICAgICAgIHRoaXMubm9kZXNMaXN0LmRlbGV0ZShjaGlsZCk7XG4gICAgICB9KTtcbiAgICB9XG5cbiAgICB0aGlzLm5vZGVzTGlzdC5kZWxldGUoZ3VpZCk7XG4gIH1cblxuICBwdWJsaWMgbmV3Tm9kZShwYXJlbnRJZCA9IG51bGwpIHtcbiAgICBjb25zdCBub2RlVGVtcGxhdGUgPSBPYmplY3QuYXNzaWduKHt9LCB0aGlzLm5vZGVUZW1wbGF0ZSk7XG5cbiAgICBub2RlVGVtcGxhdGUuZ3VpZCA9IHRoaXMudXVpZHY0KCk7XG4gICAgbm9kZVRlbXBsYXRlLnBhcmVudElkID0gcGFyZW50SWQ7XG4gICAgdGhpcy5ub2Rlc0xpc3Quc2V0KFxuICAgICAgbm9kZVRlbXBsYXRlLmd1aWQsXG4gICAgICBuZXcgVHJlZURpYWdyYW1Ob2RlKFxuICAgICAgICBub2RlVGVtcGxhdGUsXG4gICAgICAgIHRoaXMuY29uZmlnLFxuICAgICAgICB0aGlzLmdldFRoaXNOb2RlTGlzdC5iaW5kKHRoaXMpXG4gICAgICApXG4gICAgKTtcbiAgICB0aGlzLm1ha2VSb290cygpO1xuXG4gICAgcmV0dXJuIG5vZGVUZW1wbGF0ZS5ndWlkO1xuICB9XG5cbiAgcHJpdmF0ZSB1dWlkdjQoKSB7XG4gICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm9ubHktYXJyb3ctZnVuY3Rpb25zXG4gICAgcmV0dXJuICd4eHh4eHh4eC14eHh4LTR4eHgteXh4eC14eHh4eHh4eHh4eHgnLnJlcGxhY2UoL1t4eV0vZywgZnVuY3Rpb24oYykge1xuICAgICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm9uZS12YXJpYWJsZS1wZXItZGVjbGFyYXRpb24gbm8tYml0d2lzZVxuICAgICAgY29uc3QgciA9IChNYXRoLnJhbmRvbSgpICogMTYpIHwgMCxcbiAgICAgICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOnRyaXBsZS1lcXVhbHMgbm8tYml0d2lzZVxuICAgICAgICB2ID0gYyA9PSAneCcgPyByIDogKHIgJiAweDMpIHwgMHg4O1xuXG4gICAgICByZXR1cm4gdi50b1N0cmluZygxNik7XG4gICAgfSk7XG4gIH1cblxuICBwcml2YXRlIG1ha2VSb290cygpIHtcbiAgICB0aGlzLnJvb3RzID0gQXJyYXkuZnJvbSh0aGlzLnZhbHVlcygpKS5maWx0ZXIoKG5vZGU6IFRyZWVEaWFncmFtTm9kZSkgPT5cbiAgICAgIG5vZGUuaXNSb290KClcbiAgICApO1xuICB9XG59XG4iXX0=