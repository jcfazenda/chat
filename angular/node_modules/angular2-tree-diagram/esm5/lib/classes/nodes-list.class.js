import { __values } from "tslib";
import { TreeDiagramNode } from './node.class';
import { TreeDiagramNodeMaker } from './node-maker.class';
var TreeDiagramNodesList = /** @class */ (function () {
    function TreeDiagramNodesList(nodes, config) {
        var _this = this;
        this.config = config;
        this.nodeTemplate = {
            displayName: 'New node',
            children: [],
            guid: '',
            parentId: null
        };
        this.nodesList = new Map();
        nodes.forEach(function (treeNode) {
            _this.nodesList.set(treeNode.guid, new TreeDiagramNode(treeNode, config, _this.getThisNodeList.bind(_this)));
        });
        this.makeRoots();
        this.makerGuid = this.uuidv4();
        var node = {
            guid: this.makerGuid,
            parentId: 'root',
            children: [],
            displayName: 'New node'
        };
        var maker = new TreeDiagramNodeMaker(node, this.config, this.getThisNodeList.bind(this));
        this.nodesList.set(this.makerGuid, maker);
    }
    TreeDiagramNodesList.prototype.values = function () {
        return this.nodesList.values();
    };
    TreeDiagramNodesList.prototype.getNode = function (guid) {
        return this.nodesList.get(guid);
    };
    TreeDiagramNodesList.prototype.rootNode = function (guid) {
        var node = this.getNode(guid);
        var maker = this.getNode(this.makerGuid);
        node.isDragging = false;
        node.isDragover = false;
        if (node.parentId) {
            var parent_1 = this.getNode(node.parentId);
            parent_1.children.delete(guid);
        }
        node.parentId = null;
        this.makeRoots();
        maker.isDragging = false;
        maker.isDragover = false;
    };
    TreeDiagramNodesList.prototype.transfer = function (originId, targetId) {
        var origin = this.getNode(originId);
        var target = this.getNode(targetId);
        origin.isDragover = false;
        origin.isDragging = false;
        target.isDragover = false;
        if (origin.parentId === targetId || originId === targetId) {
            return;
        }
        var remakeRoots = origin.isRoot();
        if (origin.parentId) {
            var parent_2 = this.getNode(origin.parentId);
            parent_2.children.delete(originId);
            if (!parent_2.hasChildren()) {
                parent_2.toggle(false);
            }
        }
        target.children.add(originId);
        origin.parentId = targetId;
        if (remakeRoots) {
            this.makeRoots();
        }
        this.serialize();
    };
    TreeDiagramNodesList.prototype.getThisNodeList = function () {
        return this;
    };
    TreeDiagramNodesList.prototype.toggleSiblings = function (guid) {
        var e_1, _a;
        var _this = this;
        var target = this.getNode(guid);
        if (target.parentId) {
            var parent_3 = this.getNode(target.parentId);
            parent_3.children.forEach(function (nodeGuid) {
                if (nodeGuid === guid) {
                    return;
                }
                _this.getNode(nodeGuid).toggle(false);
            });
        }
        else {
            try {
                for (var _b = __values(this.roots), _c = _b.next(); !_c.done; _c = _b.next()) {
                    var root = _c.value;
                    if (root.guid === guid) {
                        continue;
                    }
                    root.toggle(false);
                }
            }
            catch (e_1_1) { e_1 = { error: e_1_1 }; }
            finally {
                try {
                    if (_c && !_c.done && (_a = _b.return)) _a.call(_b);
                }
                finally { if (e_1) throw e_1.error; }
            }
        }
    };
    TreeDiagramNodesList.prototype.serialize = function () {
        var out = [];
        this.nodesList.forEach(function (node) {
            var json = {
                guid: node.guid,
                displayName: node.displayName,
                parentId: node.parentId,
                children: Array.from(node.children),
            };
            out.push(json);
        });
        return out;
    };
    TreeDiagramNodesList.prototype.destroy = function (guid) {
        var _this = this;
        var target = this.getNode(guid);
        if (target.parentId) {
            var parent_4 = this.getNode(target.parentId);
            parent_4.children.delete(guid);
        }
        if (target.hasChildren()) {
            target.children.forEach(function (child) {
                _this.nodesList.delete(child);
            });
        }
        this.nodesList.delete(guid);
    };
    TreeDiagramNodesList.prototype.newNode = function (parentId) {
        if (parentId === void 0) { parentId = null; }
        var nodeTemplate = Object.assign({}, this.nodeTemplate);
        nodeTemplate.guid = this.uuidv4();
        nodeTemplate.parentId = parentId;
        this.nodesList.set(nodeTemplate.guid, new TreeDiagramNode(nodeTemplate, this.config, this.getThisNodeList.bind(this)));
        this.makeRoots();
        return nodeTemplate.guid;
    };
    TreeDiagramNodesList.prototype.uuidv4 = function () {
        // tslint:disable-next-line:only-arrow-functions
        return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
            // tslint:disable-next-line:one-variable-per-declaration no-bitwise
            var r = (Math.random() * 16) | 0, 
            // tslint:disable-next-line:triple-equals no-bitwise
            v = c == 'x' ? r : (r & 0x3) | 0x8;
            return v.toString(16);
        });
    };
    TreeDiagramNodesList.prototype.makeRoots = function () {
        this.roots = Array.from(this.values()).filter(function (node) {
            return node.isRoot();
        });
    };
    return TreeDiagramNodesList;
}());
export { TreeDiagramNodesList };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibm9kZXMtbGlzdC5jbGFzcy5qcyIsInNvdXJjZVJvb3QiOiJuZzovL2FuZ3VsYXIyLXRyZWUtZGlhZ3JhbS8iLCJzb3VyY2VzIjpbImxpYi9jbGFzc2VzL25vZGVzLWxpc3QuY2xhc3MudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSxjQUFjLENBQUM7QUFDL0MsT0FBTyxFQUFFLG9CQUFvQixFQUFFLE1BQU0sb0JBQW9CLENBQUM7QUFFMUQ7SUFZRSw4QkFBWSxLQUFZLEVBQVUsTUFBTTtRQUF4QyxpQkF3QkM7UUF4QmlDLFdBQU0sR0FBTixNQUFNLENBQUE7UUFQaEMsaUJBQVksR0FBRztZQUNyQixXQUFXLEVBQUUsVUFBVTtZQUN2QixRQUFRLEVBQUUsRUFBRTtZQUNaLElBQUksRUFBRSxFQUFFO1lBQ1IsUUFBUSxFQUFFLElBQUk7U0FDZixDQUFDO1FBR0EsSUFBSSxDQUFDLFNBQVMsR0FBRyxJQUFJLEdBQUcsRUFBRSxDQUFDO1FBQzNCLEtBQUssQ0FBQyxPQUFPLENBQUMsVUFBQSxRQUFRO1lBQ3BCLEtBQUksQ0FBQyxTQUFTLENBQUMsR0FBRyxDQUNoQixRQUFRLENBQUMsSUFBSSxFQUNiLElBQUksZUFBZSxDQUFDLFFBQVEsRUFBRSxNQUFNLEVBQUUsS0FBSSxDQUFDLGVBQWUsQ0FBQyxJQUFJLENBQUMsS0FBSSxDQUFDLENBQUMsQ0FDdkUsQ0FBQztRQUNKLENBQUMsQ0FBQyxDQUFDO1FBQ0gsSUFBSSxDQUFDLFNBQVMsRUFBRSxDQUFDO1FBQ2pCLElBQUksQ0FBQyxTQUFTLEdBQUcsSUFBSSxDQUFDLE1BQU0sRUFBRSxDQUFDO1FBRS9CLElBQU0sSUFBSSxHQUFHO1lBQ1gsSUFBSSxFQUFFLElBQUksQ0FBQyxTQUFTO1lBQ3BCLFFBQVEsRUFBRSxNQUFNO1lBQ2hCLFFBQVEsRUFBRSxFQUFFO1lBQ1osV0FBVyxFQUFFLFVBQVU7U0FDeEIsQ0FBQztRQUNGLElBQU0sS0FBSyxHQUFHLElBQUks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cUNBQU0sR0FBZDtRQUNFLGdEQUFnRDtRQUNoRCxPQUFPLHNDQUFzQyxDQUFDLE9BQU8sQ0FBQyxPQUFPLEVBQUUsVUFBUyxDQUFDO1lBQ3ZFLG1FQUFtRTtZQUNuRSxJQUFNLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxNQUFNLEVBQUUsR0FBRyxFQUFFLENBQUMsR0FBRyxDQUFDO1lBQ2hDLG9EQUFvRDtZQUNwRCxDQUFDLEdBQUcsQ0FBQyxJQUFJLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsR0FBRyxHQUFHLENBQUMsR0FBRyxHQUFHLENBQUM7WUFFckMsT0FBTyxDQUFDLENBQUMsUUFBUSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBQ3hCLENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUVPLHdDQUFTLEdBQWpCO1FBQ0UsSUFBSSxDQUFDLEtBQUssR0FBRyxLQUFLLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxNQUFNLEVBQUUsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxVQUFDLElBQXFCO1lBQ2xFLE9BQUEsSUFBSSxDQUFDLE1BQU0sRUFBRTtRQUFiLENBQWEsQ0FDZCxDQUFDO0lBQ0osQ0FBQztJQUNILDJCQUFDO0FBQUQsQ0FBQyxBQXBNRCxJQW9NQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFRyZWVEaWFncmFtTm9kZSB9IGZyb20gJy4vbm9kZS5jbGFzcyc7XG5pbXBvcnQgeyBUcmVlRGlhZ3JhbU5vZGVNYWtlciB9IGZyb20gJy4vbm9kZS1tYWtlci5jbGFzcyc7XG5cbmV4cG9ydCBjbGFzcyBUcmVlRGlhZ3JhbU5vZGVzTGlzdCB7XG4gIHB1YmxpYyByb290czogVHJlZURpYWdyYW1Ob2RlW107XG4gIHB1YmxpYyBtYWtlckd1aWQ6IHN0cmluZztcbiAgcHVibGljIGRyYWdnaW5nTm9kZUd1aWQ7XG4gIHByaXZhdGUgbm9kZXNMaXN0OiBNYXA8c3RyaW5nLCBUcmVlRGlhZ3JhbU5vZGU+O1xuICBwcml2YXRlIG5vZGVUZW1wbGF0ZSA9IHtcbiAgICBkaXNwbGF5TmFtZTogJ05ldyBub2RlJyxcbiAgICBjaGlsZHJlbjogW10sXG4gICAgZ3VpZDogJycsXG4gICAgcGFyZW50SWQ6IG51bGxcbiAgfTtcblxuICBjb25zdHJ1Y3Rvcihub2RlczogYW55W10sIHByaXZhdGUgY29uZmlnKSB7XG4gICAgdGhpcy5ub2Rlc0xpc3QgPSBuZXcgTWFwKCk7XG4gICAgbm9kZXMuZm9yRWFjaCh0cmVlTm9kZSA9PiB7XG4gICAgICB0aGlzLm5vZGVzTGlzdC5zZXQoXG4gICAgICAgIHRyZWVOb2RlLmd1aWQsXG4gICAgICAgIG5ldyBUcmVlRGlhZ3JhbU5vZGUodHJlZU5vZGUsIGNvbmZpZywgdGhpcy5nZXRUaGlzTm9kZUxpc3QuYmluZCh0aGlzKSlcbiAgICAgICk7XG4gICAgfSk7XG4gICAgdGhpcy5tYWtlUm9vdHMoKTtcbiAgICB0aGlzLm1ha2VyR3VpZCA9IHRoaXMudXVpZHY0KCk7XG5cbiAgICBjb25zdCBub2RlID0ge1xuICAgICAgZ3VpZDogdGhpcy5tYWtlckd1aWQsXG4gICAgICBwYXJlbnRJZDogJ3Jvb3QnLFxuICAgICAgY2hpbGRyZW46IFtdLFxuICAgICAgZGlzcGxheU5hbWU6ICdOZXcgbm9kZSdcbiAgICB9O1xuICAgIGNvbnN0IG1ha2VyID0gbmV3IFRyZWVEaWFncmFtTm9kZU1ha2VyKFxuICAgICAgbm9kZSxcbiAgICAgIHRoaXMuY29uZmlnLFxuICAgICAgdGhpcy5nZXRUaGlzTm9kZUxpc3QuYmluZCh0aGlzKVxuICAgICk7XG5cbiAgICB0aGlzLm5vZGVzTGlzdC5zZXQodGhpcy5tYWtlckd1aWQsIG1ha2VyKTtcbiAgfVxuXG4gIHB1YmxpYyB2YWx1ZXMoKSB7XG4gICAgcmV0dXJuIHRoaXMubm9kZXNMaXN0LnZhbHVlcygpO1xuICB9XG5cbiAgcHVibGljIGdldE5vZGUoZ3VpZDogc3RyaW5nKTogVHJlZURpYWdyYW1Ob2RlIHtcbiAgICByZXR1cm4gdGhpcy5ub2Rlc0xpc3QuZ2V0KGd1aWQpO1xuICB9XG5cbiAgcHVibGljIHJvb3ROb2RlKGd1aWQ6IHN0cmluZykge1xuICAgIGNvbnN0IG5vZGUgPSB0aGlzLmdldE5vZGUoZ3VpZCk7XG4gICAgY29uc3QgbWFrZXIgPSB0aGlzLmdldE5vZGUodGhpcy5tYWtlckd1aWQpO1xuXG4gICAgbm9kZS5pc0RyYWdnaW5nID0gZmFsc2U7XG4gICAgbm9kZS5pc0RyYWdvdmVyID0gZmFsc2U7XG5cbiAgICBpZiAobm9kZS5wYXJlbnRJZCkge1xuICAgICAgY29uc3QgcGFyZW50ID0gdGhpcy5nZXROb2RlKG5vZGUucGFyZW50SWQpO1xuICAgICAgcGFyZW50LmNoaWxkcmVuLmRlbGV0ZShndWlkKTtcbiAgICB9XG5cbiAgICBub2RlLnBhcmVudElkID0gbnVsbDtcblxuICAgIHRoaXMubWFrZVJvb3RzKCk7XG4gICAgbWFrZXIuaXNEcmFnZ2luZyA9IGZhbHNlO1xuICAgIG1ha2VyLmlzRHJhZ292ZXIgPSBmYWxzZTtcbiAgfVxuXG4gIHB1YmxpYyB0cmFuc2ZlcihvcmlnaW5JZDogc3RyaW5nLCB0YXJnZXRJZDogc3RyaW5nKSB7XG4gICAgY29uc3Qgb3JpZ2luID0gdGhpcy5nZXROb2RlKG9yaWdpbklkKTtcbiAgICBjb25zdCB0YXJnZXQgPSB0aGlzLmdldE5vZGUodGFyZ2V0SWQpO1xuXG4gICAgb3JpZ2luLmlzRHJhZ292ZXIgPSBmYWxzZTtcbiAgICBvcmlnaW4uaXNEcmFnZ2luZyA9IGZhbHNlO1xuICAgIHRhcmdldC5pc0RyYWdvdmVyID0gZmFsc2U7XG5cbiAgICBpZiAob3JpZ2luLnBhcmVudElkID09PSB0YXJnZXRJZCB8fCBvcmlnaW5JZCA9PT0gdGFyZ2V0SWQpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBjb25zdCByZW1ha2VSb290cyA9IG9yaWdpbi5pc1Jvb3QoKTtcblxuICAgIGlmIChvcmlnaW4ucGFyZW50SWQpIHtcbiAgICAgIGNvbnN0IHBhcmVudCA9IHRoaXMuZ2V0Tm9kZShvcmlnaW4ucGFyZW50SWQpO1xuXG4gICAgICBwYXJlbnQuY2hpbGRyZW4uZGVsZXRlKG9yaWdpbklkKTtcblxuICAgICAgaWYgKCFwYXJlbnQuaGFzQ2hpbGRyZW4oKSkge1xuICAgICAgICBwYXJlbnQudG9nZ2xlKGZhbHNlKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICB0YXJnZXQuY2hpbGRyZW4uYWRkKG9yaWdpbklkKTtcbiAgICBvcmlnaW4ucGFyZW50SWQgPSB0YXJnZXRJZDtcblxuICAgIGlmIChyZW1ha2VSb290cykge1xuICAgICAgdGhpcy5tYWtlUm9vdHMoKTtcbiAgICB9XG5cbiAgICB0aGlzLnNlcmlhbGl6ZSgpO1xuICB9XG5cbiAgcHVibGljIGdldFRoaXNOb2RlTGlzdCgpIHtcbiAgICByZXR1cm4gdGhpcztcbiAgfVxuXG4gIHB1YmxpYyB0b2dnbGVTaWJsaW5ncyhndWlkOiBzdHJpbmcpIHtcbiAgICBjb25zdCB0YXJnZXQgPSB0aGlzLmdldE5vZGUoZ3VpZCk7XG5cbiAgICBpZiAodGFyZ2V0LnBhcmVudElkKSB7XG4gICAgICBjb25zdCBwYXJlbnQgPSB0aGlzLmdldE5vZGUodGFyZ2V0LnBhcmVudElkKTtcblxuICAgICAgcGFyZW50LmNoaWxkcmVuLmZvckVhY2gobm9kZUd1aWQgPT4ge1xuICAgICAgICBpZiAobm9kZUd1aWQgPT09IGd1aWQpIHtcbiAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLmdldE5vZGUobm9kZUd1aWQpLnRvZ2dsZShmYWxzZSk7XG4gICAgICB9KTtcbiAgICB9IGVsc2Uge1xuICAgICAgZm9yIChjb25zdCByb290IG9mIHRoaXMucm9vdHMpIHtcbiAgICAgICAgaWYgKHJvb3QuZ3VpZCA9PT0gZ3VpZCkge1xuICAgICAgICAgIGNvbnRpbnVlO1xuICAgICAgICB9XG5cbiAgICAgICAgcm9vdC50b2dnbGUoZmFsc2UpO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBzZXJpYWxpemUoKSB7XG4gICAgY29uc3Qgb3V0ID0gW107XG5cbiAgICB0aGlzLm5vZGVzTGlzdC5mb3JFYWNoKChub2RlOiBUcmVlRGlhZ3JhbU5vZGUpID0+IHtcbiAgICAgIGNvbnN0IGpzb246IGFueSA9IHtcbiAgICAgICAgZ3VpZDogbm9kZS5ndWlkLFxuICAgICAgICBkaXNwbGF5TmFtZTogbm9kZS5kaXNwbGF5TmFtZSxcbiAgICAgICAgcGFyZW50SWQ6IG5vZGUucGFyZW50SWQsXG4gICAgICAgIGNoaWxkcmVuOiBBcnJheS5mcm9tKG5vZGUuY2hpbGRyZW4pLFxuICAgICAgfTtcblxuICAgICAgb3V0LnB1c2goanNvbik7XG4gICAgfSk7XG5cbiAgICByZXR1cm4gb3V0O1xuICB9XG5cbiAgcHVibGljIGRlc3Ryb3koZ3VpZDogc3RyaW5nKSB7XG4gICAgY29uc3QgdGFyZ2V0ID0gdGhpcy5nZXROb2RlKGd1aWQpO1xuXG4gICAgaWYgKHRhcmdldC5wYXJlbnRJZCkge1xuICAgICAgY29uc3QgcGFyZW50ID0gdGhpcy5nZXROb2RlKHRhcmdldC5wYXJlbnRJZCk7XG4gICAgICBwYXJlbnQuY2hpbGRyZW4uZGVsZXRlKGd1aWQpO1xuICAgIH1cblxuICAgIGlmICh0YXJnZXQuaGFzQ2hpbGRyZW4oKSkge1xuICAgICAgdGFyZ2V0LmNoaWxkcmVuLmZvckVhY2goKGNoaWxkOiBzdHJpbmcpID0+IHtcbiAgICAgICAgdGhpcy5ub2Rlc0xpc3QuZGVsZXRlKGNoaWxkKTtcbiAgICAgIH0pO1xuICAgIH1cblxuICAgIHRoaXMubm9kZXNMaXN0LmRlbGV0ZShndWlkKTtcbiAgfVxuXG4gIHB1YmxpYyBuZXdOb2RlKHBhcmVudElkID0gbnVsbCkge1xuICAgIGNvbnN0IG5vZGVUZW1wbGF0ZSA9IE9iamVjdC5hc3NpZ24oe30sIHRoaXMubm9kZVRlbXBsYXRlKTtcblxuICAgIG5vZGVUZW1wbGF0ZS5ndWlkID0gdGhpcy51dWlkdjQoKTtcbiAgICBub2RlVGVtcGxhdGUucGFyZW50SWQgPSBwYXJlbnRJZDtcbiAgICB0aGlzLm5vZGVzTGlzdC5zZXQoXG4gICAgICBub2RlVGVtcGxhdGUuZ3VpZCxcbiAgICAgIG5ldyBUcmVlRGlhZ3JhbU5vZGUoXG4gICAgICAgIG5vZGVUZW1wbGF0ZSxcbiAgICAgICAgdGhpcy5jb25maWcsXG4gICAgICAgIHRoaXMuZ2V0VGhpc05vZGVMaXN0LmJpbmQodGhpcylcbiAgICAgIClcbiAgICApO1xuICAgIHRoaXMubWFrZVJvb3RzKCk7XG5cbiAgICByZXR1cm4gbm9kZVRlbXBsYXRlLmd1aWQ7XG4gIH1cblxuICBwcml2YXRlIHV1aWR2NCgpIHtcbiAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6b25seS1hcnJvdy1mdW5jdGlvbnNcbiAgICByZXR1cm4gJ3h4eHh4eHh4LXh4eHgtNHh4eC15eHh4LXh4eHh4eHh4eHh4eCcucmVwbGFjZSgvW3h5XS9nLCBmdW5jdGlvbihjKSB7XG4gICAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6b25lLXZhcmlhYmxlLXBlci1kZWNsYXJhdGlvbiBuby1iaXR3aXNlXG4gICAgICBjb25zdCByID0gKE1hdGgucmFuZG9tKCkgKiAxNikgfCAwLFxuICAgICAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6dHJpcGxlLWVxdWFscyBuby1iaXR3aXNlXG4gICAgICAgIHYgPSBjID09ICd4JyA/IHIgOiAociAmIDB4MykgfCAweDg7XG5cbiAgICAgIHJldHVybiB2LnRvU3RyaW5nKDE2KTtcbiAgICB9KTtcbiAgfVxuXG4gIHByaXZhdGUgbWFrZVJvb3RzKCkge1xuICAgIHRoaXMucm9vdHMgPSBBcnJheS5mcm9tKHRoaXMudmFsdWVzKCkpLmZpbHRlcigobm9kZTogVHJlZURpYWdyYW1Ob2RlKSA9PlxuICAgICAgbm9kZS5pc1Jvb3QoKVxuICAgICk7XG4gIH1cbn1cbiJdfQ==